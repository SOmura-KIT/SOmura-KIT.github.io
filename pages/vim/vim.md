# Vim/Neovim

## これからVimを使用する人に向けて
Vimは非常に強力なテキストエディタである。
Vimを習得するまでには、それなりの時間を要する。
それまでは、思い通りに動かない歯痒さを我慢しなければならない。
Vimの操作が手癖になる頃には、他のエディタにはもう戻れないだろう。

最初からVim(Neovim)を選択することは悪くは無いが、VSCodeのVim拡張を使用することをおすすめする。
初心者が陥りがちなVimから出られない問題を回避できる上、VSCodeの強力な機能を簡単に使用できる。
また、可能ならばキー配列をUSにするといいだろう。キー配列を覚え直さなければならないが、こちらの方がVimとの親和性が良い。

## Vim Tutor by Somura
Vimには、vimtutorという初心者向けのコマンドが付属している。
最初はこれで学習するのが良いだろう。

この記事では、私の個人的に良いと思う取得の順序を示す。
幾つかのステップで分けるが、それぞれのステップの範囲を感覚的に出来るようになってから次のステップへ行くと良いだろう。

### Step0 Vimの概念を知る1
Step0では、Vimのモードについてだ。

このモードという概念がVimの独特なもので、敷居を上げている要因だろう。
以下に一部のモードを示す。

|モード|概要|
|---|:-:|
|normal|カーソルの移動、削除(厳密には削除では無い)など|
|insert|テキストの入力|
|visual|範囲選択|
|command|コマンドを入力、VSCodeやIDEなどの左上の"ファイル"や"編集"などに近い|

他にも、replaceモード等あるが、とりあえずは以上のもので十分である。

以下全てにおいて、モードをそれぞれ、n, i, v, cと省略する上、コマンドモードは":command"のように:から始まる。
また、Ctrlキーと他のキーの組み合わせをC-a(Ctrlを押しながらaの場合)、SHIFTキーと他のキーはAのように大文字と小文字を区別する。

何となく理解したら次のStepへ進もう。

### Step1 テキストを入力してVimから出られるようになる
Step1では、最低限の操作だ。

ここでは、Vimを使用してテキストを入力した後、保存して終了するまでを覚える。
本章で登場するキーは以下だ。

|モード|キー|概要|
|---|---|:-:|
|どこでも|**Esc**|normalモードへ移行|
|どこでも|**C-c**|Escより強い|
|n|h|カーソルを左へ移動|
|n|j|カーソルを下へ移動|
|n|k|カーソルを上へ移動|
|n|l|カーソルを右へ移動|
|n|i|insertモードへ移行|
|n|:|commandモードへ移行|
|c|:w|保存|
|c|:q|終了。ただし1回でも文字の入力、削除を行うと不可|
|c|:q!|強制終了。未保存分は破棄|
|c|:wq|保存して終了|

`h`, `j`, `k`, `l`で移動して、目的の位置でiを押してinsertモードに入る。必要分入力したら、Escキーでnormalモードへ戻る。そして、:でcommandモードへ入り、wqとして保存&終了。
また、困ったら基本的にEscキーを押してnormalモードに戻る。

これを出来るようになれば、Vimから出られなくなって困ることはないだろう。
チートシートを見なくとも出来るようになったならば、次のステップへ進もう。

### Step2 normalモードを少しましにする1
Step2では、normalモードの移動を改善する。

基本は、Step1が全てである。ただし、`h`, `j`, `k`, `l`での移動は連打が必要で少し不便だ。
私もそうであったが、始めてVimを触るとき、`h`, `j`, `k`, `l`での印象が強い。
しかし、Vimに慣れるにつれ、このキーの入力が減る。
以下のStepの多くが、`h`, `j`, `k`, `l`を減らすためのトリックとなる。

このStep2では、1キーの入力での移動を少しだけ多きくしてみる。
そのためのキーが以下だ。

|モード|キー|概要|
|---|---|:-:|
|n|w|次の単語の先頭|
|n|b|前の単語の先頭|
|n|e|次の単語の末尾|

とりあえず3つのコマンドだ。

もう一つ覚えておいて欲しいことがある。それはキーの入力数である。
"HelloWorld"を"HelloWorkd"と入力してしまった。今キーはHの位置にあり、kをlに書き換えたい。
このとき、lを8回連打してkの位置まで移動するのか。それよりもっと良い方法があるeとhを順番に押すのだ。
これなら6キー省略出来る。
このような移動の組み合わせで如何にして、少ない入力で目的を達成するか。それがVimにおいて大切なことである。

さて、これで不必要なキーの連打が減らせたら、次のStepへ進もう。

### Step3 normalモードを少しましにする2
Step2では、横の移動を少し改善した。
Step3では、さらに縦の移動を改善しよう。

VSCodeなどのGUIエディタではマウスホイールを使用してスクロールが可能である。
Vimでもこれは出来なくはない。
しかし、ホームポジションを維持できるVimの利点を潰すことになるのでこれは避けたい。

|モード|キー|概要|
|---|---|:-:|
|n|C-d|画面を半分だけ下スクロールする。downで覚える|
|n|C-u|画面を半分だけ上スクロールする。upで覚える|
|n|C-f|画面を1画面分下スクロールする。移動しすぎるので、個人的にC-dの方が良い。forwardで覚える|
|n|C-b|画面を1画面分上スクロールする。同様にC-u。backforwardで覚える|
|n|C-e|1行分上スクロールする|
|n|C-y|1行分下スクロールする|

行数が多いときに有用である。

### Step4 normalモードで移動以外を出来るようにする1
Step3まででは、normalモードを移動のみに使用した。
Step4では、normalモードを移動以外にも使用する。

このStepでは、皆大好きコピペだ。
操作としては、Cut, Yank, Putがある。 それぞれ、Vim以外での`C-x`, `C-c`, `C-v`にあたる。
このStepでは適用範囲を1行全体とした場合のものを取り扱う。
以下がそれらのコマンドである。

|モード|キー|概要|
|---|---|:-:|
|n|dd|1行をカットする|
|n|yy|1行をヤンク(コピー)する|
|n|p|貼り付ける(次のStepでもう少し詳しく)|

これだけでは使用しづらいため、次のStepでもう少し使いやすくする。

### Step5 visualモードで選択して操作する
Step4では、1行まるまるの操作だったが、これでは使いづらい。
Step5では、任意の範囲で選択して、これらを出来るようにする。

|モード|キー|概要|
|---|---|:-:|
|n|v|visualモード(通常)に移行する|
|n|V|visualモード(行選択)に移行する|
|n|C-v|visualモード(短形選択)に移行する|
|v|d|選択範囲をカットする|
|v|y|選択範囲をコピーする|
|n|p|貼り付ける。行選択なら次の行へ、通常選択ならカーソルと次の文字の間に挿入|
|n|P|貼り付ける。行選択なら前の行へ、通常選択ならカーソルと前の文字の間に挿入|
|n又はi|C-V|クリップボードから貼り付ける|

これでコピペが出来るようになった。

### Step6 insertモードへの入り方を少し工夫する
Step1では、`i`によるinsertモードへの移行を示した。
Step6では、さらに幾つかの方法を示す

|モード|キー|概要|
|---|---|:-:|
|n|i|カーソルと前の文字の間からinsertモードへ入る|
|n|I|行の先頭(インデントがあるときは、最初の非空白文字)からinsertモードへ入る|
|n|a|カーソルと次の文字の間からinsertモードへ入る|
|n|A|行末からinsertモードへ入る|
|n|o|下に空行を挿入して、その行でinsertモードへ入る|
|n|O|上に空行を挿入して、その行でinsertモードへ入る|
|n|cc|1行を削除してその行でinsertモードへ入る|
|v|c|選択範囲を削除してinsertモードへ入る|

### Step7 Vimの概念を知る2
Step4, Step5では、行削除や範囲削除を示したが、実際の`d`や`y`コマンドおよびVimのnormalモードのコマンドの正確な動作はもっと違ったものである。
Step7では、そんなテキストオブジェクトという概念を示す。

テキストオブジェクトとは、VimのNormalモードで使用可能な選択範囲の概念である。
以下にテキストオブジェクトを示す。

|テキストオブジェクト|選択範囲|
|---|:-:|
|iw|単語のみ|
|aw|単語と単語の後ろの1つの空白|
|i{,i}|{}で囲まれた内側|
|a{, a}|{}を含む|
|it|HTML, XMLタグで囲まれた内側|
|at|HTML, XMLタグを含む|

勘が良い人は気づくだろうが、{やtの部分は"や(、[など囲むことのできるものならば大抵は選択できる。
これを踏まえて`d`から始まるコマンドを整理すると

|モード|キー|概要|
|---|---|:-:|
|n|dd|1行をカット|
|n|D|カーソルから行末までをカット|
|n|d TextObject|TextObjectの選択範囲をカット|
|v|d|選択範囲をカット|

以上のようになる。これがたとえ`y`や`c`になったとしても同様である。


### Step8 もう少し効率的な移動のために
これまでにnormalモードでの移動を紹介したが、もう少しバリエーションを増やそう。

|モード|キー|概要|
|---|---|:-:|
|n|f 任意のキー|今の行の次のfの後に入力したキーの文字へ移動する|
|n|;|上記での移動の動作を繰りかえす|
|n|,|`;`の逆順|
|n|/任意の単語 Enter|ファイル全体のうち、入力した単語へ移動する|
|n|n|上記でのヒットの次の単語へ移動する|
|n|N|`n`の逆順|

### Step9 まとめ
ここまでこれば大抵のことには困らないだろう。
残りは自身で調べつつ、より良くしていくと良いだろう。

あとは、下記に記す予定の習慣を参照したり、先人の知恵(QiitaやZenn)に頼るのも良し。Vim-JPのSlackに参加するのも良いだろう。

また、VSCode拡張でなく、素のVimやNeovimを使用するならば、プラグインについても知るべきだろう。
GUIの統合こそ出来ないが、大抵のプログラミング補助の機能であれば、Vimでも実装が出来る。
プラグインを自身で選定しなくても、LazyVimやLunarVimのような導入だけでIDEの様に動作するVimディストリビューションも存在している。
とはいえ、素のVimを成長させていくのが良いだろう。それこそ、Vimの面白く深い部分である。

## 習慣

### vimrcの整理
`~/.vimrc`や`~/.config/nvim/init.vim`ではvimを設定出来る。
vimの設定はvim scriptと呼ばれる独自の言語によって行うことが出来る。
NeovimならばLuaでも設定可能であるが、結局vim scriptの知識も必要なため、これを取得することが必要である。
vim scriptの習得はvim scriptテクニックバイブルがおすすめである.

### set options
:set number のようにオプションを設定するもの。
これをvimrcに記述することで、永続化できる。
好みに合わせて、これを設定していくのが良いだろう。

### xmap
キーマップの整理は重要であろう。
Vimのデフォルトでもそこそこ使いやすいが、自身に馴染むようにこれを設定していくのが良いだろう。
normalモードならnmap、insertモードならimapのようにして`imap jj <Esc>`のように設定する。これはinsertモードで`jj`と入力したとき、`Esc`を押したときと同じ動作をさせるというものだ。

### autocmd
特定のイベントに対応して、特定の動作をさせることが出来る。
イベントは、insertモードに入ったとき、カーソルが移動したとき、など様々である。

### plugin
現代において、プラグインの導入は珍しくない。
プラグインの種類はざっと以下の通りである。

- プラグインマネージャ
    プラグインの導入やアップデートを簡単にしたり、プラグインの読み込みを遅らせて(プラグインの読み込みには時間を要する)、起動時間を短くする。
- 入力補助
    対応する括弧の自動挿入や、入力候補の表示などを行う。

- 表示
    ステータスラインの情報を増やす。Gitの差分情報を表示する。ブロックの対応を見易くするなど、補助情報を表示する。

- ファイル操作
    - ファイラ
        ファイルツリーの表示や、ファイルの追加、削除、名前変更などが可能
    - FZF
        ファジーファインダー。ファイル数が多い場合などに、検索が簡単。ファイルに限らず、大量の情報から検索する場合は代替使用できる。
